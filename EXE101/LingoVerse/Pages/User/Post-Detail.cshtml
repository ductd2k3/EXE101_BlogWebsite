@page
@model LingoVerse.Pages.User.Post_DetailModel
@{
}
<head>
    <link rel="stylesheet" href="~/css/PostDetail.css" asp-append-version="true" />
</head>
<!-- Main Content -->
<!-- Main Content -->
<div class="container mt-4">
    <div class="row">
        <!-- Article Content -->
        <div class="col-lg-6">
            <div class="article-container">
                <h1 class="article-title">AI Breakthrough in 2049</h1>
                <div class="article-meta">
                    <span><i class="far fa-clock"></i> Date: 02/03/2025</span> |
                    <span><i class="fas fa-user"></i> Author: John Future</span>
                    <br />
                    <span><i class="fas fa-eye"></i> 1,234 views</span> |
                    <span><i class="fas fa-graduation-cap"></i> Level: Intermediate</span>
                </div>
                <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=400&w=800"
                     class="article-image"
                     alt="Hình minh họa" />
                <div class="article-content">
                    <p>
                        Artificial Intelligence (AI) is entering a new era where
                        machines not only assist humans but also shape the future. In
                        2049, breakthroughs show that AI can learn, create, and even
                        make decisions for humans in many fields.
                    </p>
                    <p>
                        From self-driving cities to personalized education, the
                        possibilities are endless. This article explores how AI is
                        transforming our world.
                    </p>
                    <!-- Nội dung dài hơn để kiểm tra overflow -->
                    <p>
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do
                        eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut
                        enim ad minim veniam, quis nostrud exercitation ullamco laboris
                        nisi ut aliquip ex ea commodo consequat.
                    </p>
                    <p>
                        Duis aute irure dolor in reprehenderit in voluptate velit esse
                        cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat
                        cupidatat non proident, sunt in culpa qui officia deserunt
                        mollit anim id est laborum.
                    </p>
                </div>
                <div class="share-buttons">
                    <span>Share: </span>
                    <a href="#" title="Share on Facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="#" title="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" title="Share on LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6" style="position: relative">
            <div class="questions-container">
                <div class="questions-section">
                    <h5>Comprehension Questions</h5>
                    <div id="score" class="score-display">Điểm: 0/3</div>
                    <form id="quiz-form">
                        <div class="question-item" data-correct="q1b">
                            <p>1. What is the main topic of the article?</p>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q1"
                                       id="q1a"
                                       value="q1a" />
                                <label class="form-check-label" for="q1a">A. Space exploration</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q1"
                                       id="q1b"
                                       value="q1b" />
                                <label class="form-check-label" for="q1b">B. Artificial Intelligence</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q1"
                                       id="q1c"
                                       value="q1c" />
                                <label class="form-check-label" for="q1c">C. Time travel</label>
                            </div>
                            <div class="result" id="result1"></div>
                        </div>
                        <div class="question-item" data-correct="q2b">
                            <p>2. In which year do the breakthroughs happen?</p>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q2"
                                       id="q2a"
                                       value="q2a" />
                                <label class="form-check-label" for="q2a">A. 2025</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q2"
                                       id="q2b"
                                       value="q2b" />
                                <label class="form-check-label" for="q2b">B. 2049</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q2"
                                       id="q2c"
                                       value="q2c" />
                                <label class="form-check-label" for="q2c">C. 2100</label>
                            </div>
                            <div class="result" id="result2"></div>
                        </div>
                        <div class="question-item" data-correct="q3a">
                            <p>3. What is one application of AI mentioned?</p>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q3"
                                       id="q3a"
                                       value="q3a" />
                                <label class="form-check-label" for="q3a">A. Self-driving cities</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q3"
                                       id="q3b"
                                       value="q3b" />
                                <label class="form-check-label" for="q3b">B. Time travel machines</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="q3"
                                       id="q3c"
                                       value="q3c" />
                                <label class="form-check-label" for="q3c">C. Space colonization</label>
                            </div>
                            <div class="result" id="result3"></div>
                        </div>
                        <button type="button"
                                id="submit-answers"
                                class="custom-btn mt-2">
                            Nộp bài
                        </button>
                    </form>
                </div>
                <!-- Writing Practice Section -->
                <div class="writing-section mt-4">
                    <h5>Writing Practice</h5>
                    <div class="writing-item">
                        <p>
                            Write a short paragraph (50-100 words) about how AI might
                            change the future based on the article.
                        </p>
                        <textarea class="form-control"
                                  id="writing-input"
                                  rows="10"
                                  style="
                    background: rgba(255, 255, 255, 0.05);
                    color: #e0e1dd;
                    border: 1px solid #778da9;
                  "></textarea>
                        <button type="button"
                                id="submit-writing"
                                class="custom-btn mt-2">
                            Nộp bài
                        </button>
                        <div id="spinner" class="spinner"></div>
                        <div id="feedback" class="feedback-container"></div>
                    </div>
                </div>
            </div>
            <!-- Overlay mờ che toàn bộ col-lg-6 -->
            <div id="premium-overlay" class="premium-overlay">
                <div class="overlay-content">
                    <p>Đây là tính năng dành cho tài khoản Premium!</p>
                    <button id="upgrade-btn" class="custom-btn">Nâng cấp ngay</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm các popup -->
<div id="translate-tooltip" class="translate-tooltip">Dịch</div>
<div id="translate-popup" class="translate-popup">
    <button id="close-popup" class="close-btn">×</button>
    <h6>Dịch sang tiếng Việt</h6>
    <div id="translation-result"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
<script>
    // Quản lý trạng thái Premium
    const accountManager = {
        isPremium: true, // Trạng thái tài khoản (true = Premium)
        overlay: document.getElementById("premium-overlay"),
        upgradeBtn: document.getElementById("upgrade-btn"),

        init() {
            if (this.isPremium) {
                this.overlay.style.display = "none";
            }
            this.upgradeBtn.addEventListener("click", this.handleUpgrade.bind(this));
        },

        handleUpgrade() {
            alert("Chuyển hướng đến trang nâng cấp tài khoản!");
            // Logic nâng cấp thực tế có thể thêm ở đây
        }
    };

    // Xử lý chấm điểm câu hỏi
    const quizManager = {
        submitBtn: document.getElementById("submit-answers"),
        scoreDisplay: document.getElementById("score"),

        init() {
            this.submitBtn.addEventListener("click", this.gradeQuiz.bind(this));
        },

        gradeQuiz() {
            const questions = document.querySelectorAll(".question-item");
            let score = 0;

            questions.forEach((question, index) => {
                const correctAnswer = question.getAttribute("data-correct");
                const selectedAnswer = question.querySelector('input[type="radio"]:checked');
                const resultDiv = document.getElementById(`result${index + 1}`);

                resultDiv.style.display = "block";
                if (!selectedAnswer) {
                    this.showResult(resultDiv, "Please select an answer!", "incorrect");
                    return;
                }

                if (selectedAnswer.value === correctAnswer) {
                    this.showResult(resultDiv, "Correct!", "correct");
                    score++;
                } else {
                    const correctText = question.querySelector(`label[for="${correctAnswer}"]`).textContent;
                    this.showResult(resultDiv, `Incorrect! Correct answer: ${correctText}`, "incorrect");
                }
            });

            this.scoreDisplay.textContent = `Điểm: ${score}/${questions.length}`;
        },

        showResult(element, message, className) {
            element.textContent = message;
            element.className = `result ${className}`;
        }
    };

    // Xử lý bài viết
    const writingEvaluator = {
        submitBtn: document.getElementById("submit-writing"),
        input: document.getElementById("writing-input"),
        spinner: document.getElementById("spinner"),
        feedback: document.getElementById("feedback"),
        apiKey: "AIzaSyAi-CupGekJ5o1IrYbXUuMp9nb3kVucuUo",

        init() {
            this.submitBtn.addEventListener("click", this.evaluate.bind(this));
        },

        async evaluate() {
            const text = this.input.value.trim();
            if (!text) {
                alert("Please write something before submitting!");
                return;
            }

            this.showLoading(true);
            try {
                const feedback = await this.callApi(text);
                this.feedback.innerHTML = marked.parse(feedback);
            } catch (error) {
                this.feedback.textContent = "Đã xảy ra lỗi, vui lòng thử lại sau!";
                console.error("Evaluation error:", error);
            } finally {
                this.showLoading(false);
            }
        },

        async callApi(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`;
            const requestBody = {
                contents: [{
                    parts: [{
                        text: `
                                Đánh giá bài viết sau đây và đưa ra nhận xét chi tiết, nếu là viết linh tinh không có nghĩa thì trả về: Bạn vui lòng viết lại:

                            ${text}

                            Yêu cầu:
                            - Phân tích ngữ pháp, cú pháp đã đúng chưa.
                            - Phân tích nội dung bài viết, chỉ ra điểm mạnh và điểm cần cải thiện.
                            - Đưa ra các góp ý cụ thể để bài viết trở nên rõ ràng, mạch lạc và hấp dẫn hơn.
                            - Nhận xét về bố cục, ý tưởng chính, cách triển khai ý tưởng và ngôn ngữ sử dụng.
                            - Đánh giá mức độ phù hợp với đối tượng độc giả (ví dụ: người mới học, trình độ trung cấp hay nâng cao).
                        `
                        
                    }]
                }]
            };

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Không có phản hồi!";
        },

        showLoading(isLoading) {
            this.spinner.style.display = isLoading ? "block" : "none";
            this.feedback.innerHTML = isLoading ? "" : this.feedback.innerHTML;
        }
    };

    // Xử lý dịch văn bản
    const translator = {
        tooltip: document.getElementById("translate-tooltip"),
        popup: document.getElementById("translate-popup"),
        result: document.getElementById("translation-result"),
        closeBtn: document.getElementById("close-popup"),
        selectedText: "",
        apiKey: "AIzaSyAi-CupGekJ5o1IrYbXUuMp9nb3kVucuUo",

        init() {
            document.addEventListener("mouseup", this.handleSelection.bind(this));
            document.addEventListener("mousedown", this.hideOnClickOutside.bind(this));
            this.tooltip.addEventListener("click", this.translate.bind(this));
            this.closeBtn.addEventListener("click", () => this.popup.style.display = "none");
        },

        handleSelection(e) {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text && !this.tooltip.contains(e.target)) {
                this.selectedText = text;
                const rect = selection.getRangeAt(0).getBoundingClientRect();
                Object.assign(this.tooltip.style, {
                    top: `${rect.bottom + window.scrollY + 5}px`,
                    left: `${rect.left + window.scrollX}px`,
                    display: "block"
                });
            } else {
                this.tooltip.style.display = "none";
            }
        },

        async translate() {
            if (!this.selectedText) return;

            this.tooltip.style.display = "none";
            this.popup.style.display = "block";
            this.result.textContent = "Đang dịch...";

            try {
                const translation = await this.callTranslateApi(this.selectedText);
                this.result.textContent = translation;
            } catch (error) {
                this.result.textContent = "Lỗi khi dịch!";
                console.error("Translation error:", error);
            }
        },

        async callTranslateApi(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`;
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Dịch sang tiếng Việt: "${text}"` }] }]
                })
            });
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Không thể dịch!";
        },

        hideOnClickOutside(e) {
            if (!this.tooltip.contains(e.target) && !this.popup.contains(e.target)) {
                this.tooltip.style.display = "none";
                this.popup.style.display = "none";
            }
        }
    };

    // Khởi chạy tất cả module
    document.addEventListener("DOMContentLoaded", () => {
        accountManager.init();
        quizManager.init();
        writingEvaluator.init();
        translator.init();
    });
</script>